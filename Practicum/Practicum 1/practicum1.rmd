---
title: "Practicum 1"
author: "Kaushik Holla"
date: "3/1/2021"
output: html_document
---

```{r}
library(sqldf)
library(ggplot2)
library(DBI)
```
# Loading data into a Data frame
```{r}

bird_strike <- read.csv("BirdStrikesData.csv")

names(bird_strike) <- c("record_id", "aircraft_type", "airport_name", "altitude_bin", "aircraft_make_model", "wildlife_number_struck", "wildlife_number_struck_actual", "effect_impact_to_flight", "flight_date", "effect_indicated_damage", "aircraft_number_of_engines", "aircraft_airline_operator", "origin_state", "when_phase_of_flight", "conditions_precipitation","remains_of_wildlife_collected","remains_of_wildlife_sent_to_smithsonian", "remarks", "wildlife_size", "conditions_sky","wildlife_species","pilot_warned_of_birds_or_wildlife", "cost_total", "feet_above_ground", "number_of_people_injured", "is_aircraft_large")

```

# Splitting the dataframe into small dataframe for each table
```{r}
aircraft <- bird_strike[c("aircraft_type","aircraft_make_model","aircraft_airline_operator", "is_aircraft_large")]

aircraft_model <- bird_strike[c("aircraft_make_model","aircraft_number_of_engines")]

records <- bird_strike[c("record_id", "altitude_bin","cost_total","remarks","number_of_people_injured","conditions_precipitation","conditions_sky")]

flight <- bird_strike[c("airport_name","effect_impact_to_flight","flight_date","when_phase_of_flight","pilot_warned_of_birds_or_wildlife","feet_above_ground","effect_indicated_damage")]

airport <- bird_strike[c("airport_name","origin_state")]

wildlife <- bird_strike[c("wildlife_number_struck", "wildlife_number_struck_actual", "remains_of_wildlife_collected", "remains_of_wildlife_sent_to_smithsonian", "wildlife_size", "wildlife_species")]

```


## Connecting to MySQL Database
```{r}
con <- dbConnect(RMySQL::MySQL(),
                 dbname = "birdstrike",
                 host = "db4free.net",
                 port = 3306,
                 user = "kholla",
                 password = "kholla@123")
```


## Code to create tables
```{sql connection=con}
DROP table flight;
```

```{sql connection=con}
DROP table aircraft_model;
```

```{sql connection=con}

CREATE TABLE IF NOT EXISTS aircraft(
  aircraft_id INT AUTO_INCREMENT PRIMARY KEY,
  aircraft_type VARCHAR(300),
  aircraft_make_model VARCHAR(300),
  aircraft_airline_operator VARCHAR(300),
  is_aircraft_large VARCHAR(300)
);
```

```{sql connection=con}
CREATE TABLE IF NOT EXISTS aircraft_model(
  aircraft_make_model VARCHAR(300) PRIMARY KEY,
  aircraft_number_of_engines INT
);
```

```{sql connection=con}
CREATE TABLE IF NOT EXISTS flight(
  flight_id INT AUTO_INCREMENT PRIMARY KEY,
  airport_name VARCHAR(300),
  effect_impact_to_flight VARCHAR(300),
  flight_date DATETIME,
  when_phase_of_flight VARCHAR(300),
  pilot_warned_of_birds_or_wildlife VARCHAR(300),
  feet_above_ground VARCHAR(300),
  effect_indicated_damage VARCHAR(300),
  aircraft_id INT, 
  FOREIGN KEY(aircraft_id) REFERENCES aircraft(aircraft_id) 
);
```

```{sql connection=con}
CREATE TABLE IF NOT EXISTS wildlife(
  wildlife_id INT AUTO_INCREMENT PRIMARY KEY,
  wildlife_number_struck VARCHAR(300),
  wildlife_number_struck_actual VARCHAR(300),
  remains_of_wildlife_collected VARCHAR(300),
  remains_of_wildlife_sent_to_smithsonian VARCHAR(300),
  wildlife_size VARCHAR(300),
  wildlife_species VARCHAR(300)
);
```

```{sql connection=con}
CREATE TABLE IF NOT EXISTS records(
  record_id VARCHAR(300) PRIMARY KEY,
  altitude_bin VARCHAR(300),
  cost_total INT,
  remarks TEXT,
  number_of_people_injured INT,
  conditions_precipitation VARCHAR(300),
  conditions_sky VARCHAR(300),
  wildlife_id INT,
  flight_id INT,
  FOREIGN KEY (wildlife_id) REFERENCES wildlife(wildlife_id),
  FOREIGN KEY (flight_id) REFERENCES flight(flight_id)
);
```

```{sql connection=con}
CREATE TABLE IF NOT EXISTS airport(
  airport_name VARCHAR(300) PRIMARY KEY,
  origin_state VARCHAR(300)
);
```


## Loading Data to Database table
## Loading into aircraft table
```{r}
sql <- "INSERT INTO aircraft (aircraft_type, aircraft_make_model, aircraft_airline_operator, is_aircraft_large) 
        VALUES (?param1, ?param2, ?param3, ?param4)"

for (i in 1:nrow(aircraft)) {
  # BIND PARAMS
  query <- sqlInterpolate(con, sql, param1 = aircraft[i,1], param2 = aircraft[i,2], 
                          param3 = aircraft[i,3], param4 = aircraft[i,4])
  # EXECUTE QUERY
  dbSendQuery(con, query)
}
```

## Loading into wildlife table
```{r}
sql <- "INSERT INTO wildlife (wildlife_number_struck, wildlife_number_struck_actual, remains_of_wildlife_collected, remains_of_wildlife_sent_to_smithsonian, wildlife_size, wildlife_species) 
        VALUES (?param1, ?param2, ?param3, ?param4, ?param5, ?param6)"

for (i in 1:nrow(wildlife)) {
  # BIND PARAMS
  query <- sqlInterpolate(con, sql, param1 = wildlife[i,1], param2 = wildlife[i,2], 
                          param3 = wildlife[i,3], param4 = wildlife[i,4], param5 = wildlife[i,5], param6 = wildlife[i,6])
  # EXECUTE QUERY
  dbSendQuery(con, query)
}
```


## Data Analysis
```{r}
sqldf("select * from airport group by airport_name")
```




4. (10 pts / 45 min) Create a SQL query against your database to find the number of bird strikes for each airport upon take-off or climb. Include all airlines. You may either use a {sql} code chunk or an R function to execute the query.
```{r}
sqldf('select airport_name, count(record_id) as Number_Of_BirdStrikes from bird_strike where when_phase_of_flight = "Take-off run" or when_phase_of_flight = "Climb" group by airport_name')

```

5. (10 pts / 45 min) Create a SQL query against your database to find the airports that had the most bird strike incidents (during any flight phase). Include all airlines. You may either use a {sql} code chunk or an R function to execute the query.
```{r}

sqldf('select airport_name, count(record_id) as Number_Of_BirdStrikes from bird_strike group by airport_name order by 2 desc')

```

6. (10 pts / 45 min) Create a SQL query against your database to find the number of bird strike incidents by year. Include all airlines. You may either use a {sql} code chunk or an R function to execute the query.
```{r}
bird_strike$year <- format(as.Date(bird_strike$flight_date, format="%m/%d/%Y"),"%Y")

```

```{r}

sqldf('select year, count(record_id) as Number_Of_BirdStrikes from bird_strike group by year order by 2 desc')


```

7. (10 pts / 90 min) Using the above data, build a line graph that visualizes the number of bird strikes incidents per year from 2000 to 2011. Adorn the graph with appropriate axis labels.

```{r}
bird_strikes_year <- sqldf('select year, count(record_id) as Number_Of_BirdStrikes from bird_strike where year >= 2000 and year <= 2010 group by year order by 2 desc')

ggplot(data = bird_strikes_year, aes(x = year, y = Number_Of_BirdStrikes, group = 1)) +
  geom_line(linetype = "dashed", color = "red") 

```


8. (10 pts / 2 hrs) Create a stored procedure in MySQL (note that if you used SQLite, then you cannot complete this step) that adds a new bird strikes incident to the database. You only need to include the following data: airport name, aircraft type, flight date, airline, flight phase. The remaining columns can be set with default values as defined by the table definitions. Show that the insertion worked as expected by retrieving and displaying the inserted data.
```{r}


```